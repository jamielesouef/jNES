//
//  CPUMock.swift
//  SwiftNESTests
//
//  Created by Jamie Le Souef on 11/4/2024.
//

import Foundation
@testable import SwiftNES

class MockRegisters: Registers {
  override func reset() {
    
  }
}

let game_code: [UInt8] = [
    0x20, 0x06, 0x06, 0x20, 0x38, 0x06, 0x20, 0x0d, 0x06, 0x20, 0x2a, 0x06, 0x60, 0xa9, 0x02, 0x85,
    0x02, 0xa9, 0x04, 0x85, 0x03, 0xa9, 0x11, 0x85, 0x10, 0xa9, 0x10, 0x85, 0x12, 0xa9, 0x0f, 0x85,
    0x14, 0xa9, 0x04, 0x85, 0x11, 0x85, 0x13, 0x85, 0x15, 0x60, 0xa5, 0xfe, 0x85, 0x00, 0xa5, 0xfe,
    0x29, 0x03, 0x18, 0x69, 0x02, 0x85, 0x01, 0x60, 0x20, 0x4d, 0x06, 0x20, 0x8d, 0x06, 0x20, 0xc3,
    0x06, 0x20, 0x19, 0x07, 0x20, 0x20, 0x07, 0x20, 0x2d, 0x07, 0x4c, 0x38, 0x06, 0xa5, 0xff, 0xc9,
    0x77, 0xf0, 0x0d, 0xc9, 0x64, 0xf0, 0x14, 0xc9, 0x73, 0xf0, 0x1b, 0xc9, 0x61, 0xf0, 0x22, 0x60,
    0xa9, 0x04, 0x24, 0x02, 0xd0, 0x26, 0xa9, 0x01, 0x85, 0x02, 0x60, 0xa9, 0x08, 0x24, 0x02, 0xd0,
    0x1b, 0xa9, 0x02, 0x85, 0x02, 0x60, 0xa9, 0x01, 0x24, 0x02, 0xd0, 0x10, 0xa9, 0x04, 0x85, 0x02,
    0x60, 0xa9, 0x02, 0x24, 0x02, 0xd0, 0x05, 0xa9, 0x08, 0x85, 0x02, 0x60, 0x60, 0x20, 0x94, 0x06,
    0x20, 0xa8, 0x06, 0x60, 0xa5, 0x00, 0xc5, 0x10, 0xd0, 0x0d, 0xa5, 0x01, 0xc5, 0x11, 0xd0, 0x07,
    0xe6, 0x03, 0xe6, 0x03, 0x20, 0x2a, 0x06, 0x60, 0xa2, 0x02, 0xb5, 0x10, 0xc5, 0x10, 0xd0, 0x06,
    0xb5, 0x11, 0xc5, 0x11, 0xf0, 0x09, 0xe8, 0xe8, 0xe4, 0x03, 0xf0, 0x06, 0x4c, 0xaa, 0x06, 0x4c,
    0x35, 0x07, 0x60, 0xa6, 0x03, 0xca, 0x8a, 0xb5, 0x10, 0x95, 0x12, 0xca, 0x10, 0xf9, 0xa5, 0x02,
    0x4a, 0xb0, 0x09, 0x4a, 0xb0, 0x19, 0x4a, 0xb0, 0x1f, 0x4a, 0xb0, 0x2f, 0xa5, 0x10, 0x38, 0xe9,
    0x20, 0x85, 0x10, 0x90, 0x01, 0x60, 0xc6, 0x11, 0xa9, 0x01, 0xc5, 0x11, 0xf0, 0x28, 0x60, 0xe6,
    0x10, 0xa9, 0x1f, 0x24, 0x10, 0xf0, 0x1f, 0x60, 0xa5, 0x10, 0x18, 0x69, 0x20, 0x85, 0x10, 0xb0,
    0x01, 0x60, 0xe6, 0x11, 0xa9, 0x06, 0xc5, 0x11, 0xf0, 0x0c, 0x60, 0xc6, 0x10, 0xa5, 0x10, 0x29,
    0x1f, 0xc9, 0x1f, 0xf0, 0x01, 0x60, 0x4c, 0x35, 0x07, 0xa0, 0x00, 0xa5, 0xfe, 0x91, 0x00, 0x60,
    0xa6, 0x03, 0xa9, 0x00, 0x81, 0x10, 0xa2, 0x00, 0xa9, 0x01, 0x81, 0x10, 0x60, 0xa2, 0x00, 0xea,
    0xea, 0xca, 0xd0, 0xfb, 0x60
];

class MockMemory: MemoryInjectable {
  func load(program: [UInt8]) {
    print("Mock Loading program is noop")
  }
  
  func setProgramCounter(_ value: UInt16) {
    log("sc", value)
    self.programCounter = value
  }
  
  func getProgramCounter() -> UInt16 {
    log("gc", self.programCounter)
    return self.programCounter
  }
  
  func readMemAtCounter() -> UInt8 {
    return self.buffer[Int(self.programCounter)]
  }
  
  
  var buffer: [UInt8]
  var stackPointer: UInt8 = 0
  var programCounter: UInt16 = 0
  var registers: Registers
    
  init(buffer: [UInt8], stackPointer: UInt8) {
    self.buffer = buffer
    self.stackPointer = stackPointer
    self.registers = MockRegisters(A: 0x33, X: 0x10, Y: 0xFF, p: 0x00)
  }
  
  func getAddress(for mode: SwiftNES.AddressingMode) -> UInt16 {
    getProgramCounter()
  }
  
  func writeBuffer(at address: UInt16, value: UInt8) {
    buffer[address] = value
  }
  
  func readBuffer(at address: UInt16) -> UInt8 {
    return buffer[address]
  }
  
  func setStackPointer(_ value: UInt8) {
    log("p", value)
    self.stackPointer = value
  }
  
  func getStackPointer() -> UInt8 {
    
    return self.stackPointer
  }
}

extension CPU {
  static func mock() -> CPU {
    
    let zeroPage: [UInt8] =  [21,62,148,13,16,143,207,111,149,249,104,194,225,233,29,251,140,34,169,125,240,6,18,66,117,194,77,29,124,172,113,155,84,48,70,62,68,81,43,171,34,75,161,39,254,51,163,59,42,26,14,96,254,232,82,247,103,1,23,29,193,115,63,67,59,84,86,109,186,41,189,69,249,30,6,216,72,225,201,158,193,236,98,106,203,86,54,99,96,79,24,75,238,108,153,207,182,71,5,24,79,194,192,157,241,241,173,140,87,30,196,86,39,180,151,106,89,164,222,178,228,21,197,92,84,228,68,48,194,40,86,121,120,202,103,152,6,29,128,230,143,32,105,164,212,237,83,61,232,27,190,36,229,202,89,228,158,201,47,220,111,80,179,207,161,151,130,63,112,178,40,211,135,56,190,123,204,71,240,120,239,119,35,128,223,39,134,122,15,228,180,211,197,159,224,1,51,201,85,51,221,212,244,25,65,51,1,57,46,44,5,240,199,1,147,107,25,123,85,93,81,27,106,178,59,136,186,100,170,34,121,245,22,198,189,75,240,114,107,152,176,186,71,192,78,12,170,199,2,155,145,221,70,64,56,192]
    
    var buffer: [UInt8] = Array(repeating: 0, count: 0xFFFF)
    let stack: [UInt8] = Array(repeating: 0, count: 0xFF)
    buffer.insert(contentsOf: zeroPage, at: 0)
    buffer.insert(contentsOf: stack, at: 0x0100)
    buffer.insert(contentsOf: programMock, at: 0x8000)
    
    let memory = MockMemory(buffer: buffer, stackPointer: 0xFF)
    return CPU(memory: memory)
  }
}
