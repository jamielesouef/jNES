//
//  rom.swift
//  SwiftNES
//
//  Created by Jamie Le Souef on 19/4/2024.
//

import Foundation

fileprivate let NES_TAG: [UInt8] = [0x4E, 0x45, 0x53, 0x1A]


struct Rom {
  let prgRom: [UInt8]
  let chrRom: [UInt8]
  
  init(cartrage: [UInt8]) {
    if Array(cartrage[0..<4]) != NES_TAG {
      fatalError("Invalid NES file")
    }
    
    // get mapper
    let mapper = (cartrage[7] & 0b1111_0000) | (cartrage[6] >> 4);
    
    // check if the file is in iNES format
    if cartrage[7] & 0x0C != 0 {
      fatalError("Only iNES format is supported")
    }
    
    // get four screen mode
    let fourScreenMode = cartrage[6] & 0x08 != 0
    
    
  }
}

let _debug_compiledSnake: [UInt16: String] = [
  0x0600: "JSR $0606 INIT",
  0x0603: "JSR $0638 LOOP",
  0x0606: "JSR $060D initSnake",
  0x0609: "JSR $062A generateApplePosition",
  0x060C: "RTS",
  0x060D: "LDA #$02",
  0x060F: "STA $02",
  0x0611: "LDA #$04",
  0x0613: "STA $03",
  0x0615: "LDA #$11",
  0x0617: "STA $10",
  0x0619: "LDA #$10",
  0x061B: "STA $12",
  0x061D: "LDA #$0F",
  0x061F: "STA $14",
  0x0621: "LDA #$04",
  0x0623: "STA $11",
  0x0625: "STA $13",
  0x0627: "STA $15",
  0x0629: "RTS",
  0x062A: "LDA $FE",
  0x062C: "STA $00",
  0x062E: "LDA $FE",
  0x0630: "AND #$03",
  0x0632: "CLC",
  0x0633: "ADC #$02",
  0x0635: "STA $01",
  0x0637: "RTS",
  0x0638: "JSR $064D READKEYS",
  0x063B: "JSR $068D checkCollision",
  0x063E: "JSR $06C3 updateSnake",
  0x0641: "JSR $0719 drawApple",
  0x0644: "JSR $0720 drawSnake",
  0x0647: "JSR $072D spinWheels",
  0x064A: "JMP $0638",
  0x064D: "LDA $FF",
  0x064F: "CMP #$77",
  0x0651: "BEQ $0660 UPKEY",
  0x0653: "CMP #$64",
  0x0655: "BEQ $066B RIGHTKEY",
  0x0657: "CMP #$73",
  0x0659: "BEQ $0676 DOWNKEY",
  0x065B: "CMP #$61",
  0x065D: "BEQ $0681 LEFTKEY",
  0x065F: "RTS",
  0x0660: "LDA #$04",
  0x0662: "BIT $02",
  0x0664: "BNE $068C",
  0x0666: "LDA #$01",
  0x0668: "STA $02",
  0x066A: "RTS",
  0x066B: "LDA #$08",
  0x066D: "BIT $02",
  0x066F: "BNE $068C",
  0x0671: "LDA #$02",
  0x0673: "STA $02",
  0x0675: "RTS",
  0x0676: "LDA #$01",
  0x0678: "BIT $02",
  0x067A: "BNE $068C",
  0x067C: "LDA #$04",
  0x067E: "STA $02",
  0x0680: "RTS",
  0x0681: "LDA #$02",
  0x0683: "BIT $02",
  0x0685: "BNE $068C",
  0x0687: "LDA #$08",
  0x0689: "STA $02",
  0x068B: "RTS",
  0x068C: "RTS",
  0x068D: "JSR $0694 checkAppleCollision",
  0x0690: "JSR $06A8 checkSnakeCollision",
  0x0693: "RTS",
  0x0694: "LDA $00",
  0x0696: "CMP $10",
  0x0698: "BNE $06A7",
  0x069A: "LDA $01",
  0x069C: "CMP $11",
  0x069E: "BNE $06A7",
  0x06A0: "INC $03",
  0x06A2: "INC $03",
  0x06A4: "JSR $062A GENERATE",
  0x06A7: "RTS",
  0x06A8: "LDX #$0:",
  0x06AA: "LDA $10,X",
  0x6AC: "CMP $10",
  0x06AE: "BNE $06B6 continueCollisionLoop",
  0x06B0: "LDA $11,X",
  0x6B2: "CMP $11",
  0x06B4: "BEQ $06BF didCollide",
  0x06B6: "INX",
  0x6B7: "INX",
  0x6B8: "CPX $03",
  0x06BA: "BEQ $06C2 didntCollide",
  0x06BC: "JMP $06AA snakeCollisionLoop",
  0x06BF: "JMP $0735 GAMEOVER",
  0x06C2: "RTS 06C2",
  0x06C3: "LDX $03",
  0x06C5: "DEX",
  0x6C6: "TXA",
  0x06C7: "LDA $10,X updateloop",
  0x6C9: "STA $12,X",
  0x6CB: "DEX",
  0x6CC: "BPL $06C7 branch to updateloop",
  0x06CE: "LDA $02",
  0x06D0: "LSR A",
  0x06D1: "BCS $06DC",
  0x06D3: "LSR A",
  0x06D4: "BCS $06EF",
  0x06D6: "LSR A",
  0x06D7: "BCS $06F8",
  0x06D9: "LSR A",
  0x06DA: "BCS $070B",
  0x06DC: "LDA $10",
  0x06DE: "SEC",
  0x06DF: "SBC #$20",
  0x06E1: "STA $10",
  0x06E3: "BCC $06E6",
  0x06E5: "RTS",
  0x06E6: "DEC $11",
  0x06E8: "LDA #$01",
  0x06EA: "CMP $11",
  0x06EC: "BEQ $0716",
  0x06EE: "RTS",
  0x06EF: "INC $10",
  0x06F1: "LDA #$1F",
  0x06F3: "BIT $10",
  0x06F5: "BEQ $0716",
  0x06F7: "RTS",
  0x06F8: "LDA $10",
  0x06FA: "CLC",
  0x06FB: "ADC #$20",
  0x06FD: "STA $10",
  0x06FF: "BCS $0702",
  0x0701: "RTS",
  0x0702: "INC $11",
  0x0704: "LDA #$06",
  0x0706: "CMP $11",
  0x0708: "BEQ $0716",
  0x070A: "RTS",
  0x070B: "DEC $10",
  0x070D: "LDA $10",
  0x070F: "AND #$1F",
  0x0711: "CMP #$1F",
  0x0713: "BEQ $0716",
  0x0715: "RTS",
  0x0716: "JMP $0735 GAMEOVER",
  0x0719: "LDY #$00",
  0x071B: "LDA $FE",
  0x071D: "STA ($00),Y",
  0x071F: "RTS",
  0x0720: "LDX $03",
  0x0722: "LDA #$00",
  0x0724: "STA ($10,X)",
  0x0726: "LDX #$0:",
  0x0728: "LDA #$01",
  0x072A: "STA ($10,X)",
  0x072C: "RTS",
  0x072D: "LDX #$0:",
  0x072F: "NOP",
  0x0730: "NOP",
  0x0731: "DEX",
  0x732: "BNE $072F",
  0x0734: "RTS",
  ]

